version: '3.9'

# PROJECT_ROOT: absolute path to project root (set by Makefile, run_all.sh, or CI)
# Default: parent of docker/ for backward compatibility
services:
  agent:
    build:
      context: ${PROJECT_ROOT:-..}
      dockerfile: docker/Dockerfile
    container_name: financial-regulation-agent
    ports:
      - "8000:8000"
    volumes:
      - ${PROJECT_ROOT:-..}:/app
      - ${PROJECT_ROOT:-..}/data:/app/data
      - ${PROJECT_ROOT:-..}/logs:/app/logs
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_TRACING_V2=true
      - LANGCHAIN_PROJECT=financial-regulation-agent
      - DEBUG=${DEBUG:-false}
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
    depends_on:
      - chroma
    command: uvicorn app.main:api --host 0.0.0.0 --port 8000 --reload

  chroma:
    image: chromadb/chroma:latest
    container_name: chroma-vector-db
    ports:
      - "8001:8000"
    volumes:
      - ${PROJECT_ROOT:-..}/data/chroma_db:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE

volumes:
  chroma_data: