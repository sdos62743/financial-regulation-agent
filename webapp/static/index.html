<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RegIntel | Institutional Regulatory AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-main: #f8fafc;
      --card-white: #ffffff;
      --accent-primary: #2563eb;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-light: #e2e8f0;
    }
    
    body { 
      background-color: var(--bg-main); 
      color: var(--text-main);
      font-family: 'Inter', sans-serif; 
    }
    
    .chat-container { 
      height: 70vh; 
      overflow-y: auto; 
    }

    /* Professional Bubbles */
    .user-bubble { 
      background-color: var(--accent-primary);
      color: white;
      border-radius: 1rem 1rem 0 1rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .agent-bubble { 
      background-color: var(--card-white);
      border: 1px solid var(--border-light);
      color: var(--text-main);
      border-radius: 1rem 1rem 1rem 0;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    }

    /* Markdown Overrides to prevent 'marked' crashes and style properly */
    .agent-content h1, .agent-content h2 { font-weight: 700; color: var(--accent-primary); margin: 1rem 0 0.5rem; }
    .agent-content p { margin-bottom: 0.75rem; line-height: 1.6; }
    .agent-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
    .agent-content code { background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9em; }

    .source-tag {
      background: #f1f5f9;
      border: 1px solid var(--border-light);
      transition: all 0.2s;
    }
    .source-tag:hover { border-color: var(--accent-primary); background: #eff6ff; }

    /* Loading dots */
    .dot { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-blue-600 rounded flex items-center justify-center">
          <i class="fa-solid fa-building-columns text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-900">RegIntel <span class="text-blue-600 font-medium text-sm">v1.0</span></h1>
          <p class="text-[10px] uppercase tracking-wider text-slate-400 font-bold">Institutional Terminal</p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <button onclick="window.print()" class="text-xs font-semibold text-slate-500 hover:text-blue-600 px-3 py-2 rounded-md transition-colors">
          <i class="fa-solid fa-download mr-1"></i> Export
        </button>
        <button onclick="resetChat()" class="text-xs font-semibold text-slate-500 hover:text-red-600 px-3 py-2 rounded-md transition-colors">
          <i class="fa-solid fa-trash-can mr-1"></i> Clear
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-4xl w-full mx-auto p-4 flex flex-col">
    <div id="chat" class="chat-container space-y-6 pt-4 pb-12 pr-2">
      <div class="flex justify-start">
        <div class="agent-bubble max-w-[85%] px-5 py-4">
          <div class="agent-content">
            <p>Welcome to <strong>RegIntel</strong>. I am ready to analyze financial regulations, FOMC minutes, or SEC filings. How can I assist you today?</p>
          </div>
        </div>
      </div>
    </div>

    <div class="sticky bottom-6 bg-transparent pt-4">
      <div id="sessionIndicator" class="mb-2 ml-2 text-[10px] text-slate-400 font-medium uppercase">
        Connecting...
      </div>
      <div class="bg-white border border-slate-200 rounded-2xl shadow-xl flex items-center p-2 focus-within:ring-2 ring-blue-500/20 ring-offset-2 transition-all">
        <input 
          id="queryInput"
          type="text" 
          placeholder="Enter regulatory query..." 
          class="flex-1 bg-transparent px-4 py-3 outline-none text-slate-700 placeholder:text-slate-400"
          onkeypress="if(event.key === 'Enter') sendQuery()">
        <button 
          id="sendBtn"
          onclick="sendQuery()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-semibold transition-all flex items-center gap-2">
          <span>Analyze</span>
          <i class="fa-solid fa-arrow-right text-xs"></i>
        </button>
      </div>
    </div>
  </main>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('queryInput');
    const sendBtn = document.getElementById('sendBtn');
    const sessionIndicator = document.getElementById('sessionIndicator');

    let currentThreadId = null;

    function initSession(isReset = false) {
      if (isReset) sessionStorage.removeItem('regintel_thread_id');
      currentThreadId = sessionStorage.getItem('regintel_thread_id') || 'session_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('regintel_thread_id', currentThreadId);
      sessionIndicator.innerText = `Active Session: ${currentThreadId}`;
    }

    function addMessage(content, isUser, sources = []) {
      const div = document.createElement('div');
      div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
      
      let sourceHtml = "";
      if (!isUser && sources && sources.length > 0) {
          sourceHtml = `
            <div class="mt-4 pt-3 border-t border-slate-100">
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Sources</p>
              <div class="flex flex-wrap gap-2">
                ${sources.map(s => `
                  <div class="source-tag px-2 py-1 rounded text-[10px] text-slate-600 font-medium">
                    <i class="fa-solid fa-link mr-1 opacity-50"></i>${s.title || 'Regulatory Doc'}
                  </div>
                `).join('')}
              </div>
            </div>`;
      }

      // Safe markdown parsing to prevent crashes
      const safeContent = typeof content === 'string' ? content : JSON.stringify(content);
      const parsedContent = isUser ? safeContent : marked.parse(safeContent);

      div.innerHTML = `
        <div class="max-w-[85%] px-5 py-4 ${isUser ? 'user-bubble' : 'agent-bubble'}">
          <div class="agent-content text-[15px]">
            ${parsedContent}
          </div>
          ${sourceHtml}
        </div>
      `;
      chat.appendChild(div);
      chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
    }

    async function sendQuery() {
      const query = input.value.trim();
      if (!query) return;

      addMessage(query, true);
      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      const loadingId = 'loading-' + Date.now();
      const loadingDiv = document.createElement('div');
      loadingDiv.id = loadingId;
      loadingDiv.className = "flex justify-start mb-4";
      loadingDiv.innerHTML = `<div class="agent-bubble px-5 py-3 text-sm text-slate-500 font-medium">Computing<span class="dot">.</span><span class="dot" style="animation-delay:0.2s">.</span><span class="dot" style="animation-delay:0.4s">.</span></div>`;
      chat.appendChild(loadingDiv);

      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "X-API-Key": "7815e7a73b7e5ff2ead305d2bbdbd9763b52a453eb6516ecb72d13a9550e12a1" // Align with server.py dependency
          },
          body: JSON.stringify({ query: query, thread_id: currentThreadId })
        });

        const data = await res.json();
        document.getElementById(loadingId).remove();

        if (data.error) {
          addMessage(`**System Warning:** ${data.error}`, false);
        } else {
          // Priority to data.answer or data.synthesized_response
          addMessage(data.answer || data.synthesized_response || "No data returned.", false, data.sources || data.documents);
        }
      } catch (err) {
        document.getElementById(loadingId)?.remove();
        addMessage("**Connection Error:** Could not reach the intelligence engine.", false);
        console.error(err);
      } finally {
          input.disabled = false;
          sendBtn.disabled = false;
          input.focus();
      }
    }

    function resetChat() {
      if (confirm("Reset analysis session?")) {
        chat.innerHTML = '';
        initSession(true);
        addMessage("New session initialized. Data state cleared.", false);
      }
    }

    initSession();
  </script>
</body>
</html>